{% assign all_contents = site.blog | where_exp:'item','item.type != nil and item.hide != true' %}
{% assign highlighted = all_contents | where_exp:'item','item.highlight != nil' | sort: 'highlight' %}
{% assign normal = all_contents | where_exp:'item','item.highlight == nil' %}
{% assign combined = highlighted | concat: normal %}

<section id="blog" x-cloak class="py-8 px-4"
  :class="darkMode ? 'bg-gray-950 text-gray-100' : 'bg-gray-50 text-gray-900'">
  <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="mb-6">
      <h2 class="text-3xl font-bold mb-2">Blog & Projects</h2>
      <p :class="darkMode ? 'text-gray-300 italic' : 'text-gray-600 italic'">For work, research, or fun</p>
    </div>

    <!-- Filters -->
    <div class="flex flex-wrap gap-4 mb-6">
      <!-- Type Filter -->
      <div class="min-w-[150px]">
        <label for="blogTypeFilter" class="block text-sm font-medium mb-1"
          :class="darkMode ? 'text-gray-200' : 'text-gray-700'">Type</label>
        <select
          id="blogTypeFilter"
          class="w-full px-3 py-2 rounded-lg border border-gray-200 text-sm focus:outline-none focus:border-blue-500"
          :class="darkMode ? 'bg-gray-900 text-gray-200 border-gray-800' : 'bg-white text-gray-700'">
          <option value="all">All</option>
          {% assign all_types = combined | map: 'type' | uniq %}
          {% for t in all_types %}
          <option value="{{ t }}">{{ t | capitalize }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- Tag Filter -->
      <div class="min-w-[150px]">
        <label for="blogTagFilter" class="block text-sm font-medium mb-1"
          :class="darkMode ? 'text-gray-200' : 'text-gray-700'">Tag</label>
        <select
          id="blogTagFilter"
          class="w-full px-3 py-2 rounded-lg border border-gray-200 text-sm focus:outline-none focus:border-blue-500"
          :class="darkMode ? 'bg-gray-900 text-gray-200 border-gray-800' : 'bg-white text-gray-700'">
          <option value="all">All</option>
          {% assign all_tags = combined | map: 'tags' | compact | flatten | uniq %}
          {% for tag in all_tags %}
          <option value="{{ tag | downcase }}">{{ tag }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- Search -->
      <div class="flex-1 min-w-[200px]">
        <label for="blogSearchInput" class="block text-sm font-medium mb-1"
          :class="darkMode ? 'text-gray-200' : 'text-gray-700'">
          Search
        </label>
        <input
          id="blogSearchInput"
          type="text"
          placeholder="Search by title, author, or description..."
          class="w-full px-3 py-2 rounded-lg border border-gray-200 text-sm focus:outline-none focus:border-blue-500"
          :class="darkMode ? 'bg-gray-900 text-gray-200 border-gray-800' : 'bg-white text-gray-700'">
      </div>
    </div>

    <div id="blogGrid" class="space-y-6">
      {% for post in combined %}
        {% capture stripped_content %}{{ post.content | strip_html | strip_newlines }}{% endcapture %}
        {% assign word_count = stripped_content | split:' ' | size %}
        {% assign read_time = word_count | divided_by:250 %}
        {% if read_time == 0 %}{% assign read_time = 1 %}{% endif %}

        {% assign ctype = site.data.content_icons[post.type] %}
        {% if ctype == nil %}
          {% assign ctype_icon = 'book' %}
          {% assign ctype_label = post.type | capitalize %}
          {% assign display_event_fields = false %}
          {% assign display_read_time = false %}
        {% else %}
          {% assign ctype_icon = ctype.icon %}
          {% assign ctype_label = ctype.label %}
          {% assign display_event_fields = ctype.display_event_fields %}
          {% assign display_read_time = ctype.display_read_time %}
        {% endif %}

      <a
        href="{{ post.url | relative_url }}"
        class="block group rounded-xl p-6 shadow-md transition-all duration-300 border border-gray-100"
        :class="darkMode ? 'bg-gray-900' : 'bg-white'"
      >
        <!-- 
          NOTE: We make the card relative so we can absolutely position the image on mobile.
          On mobile: flex-col, image on top (absolute), text below with padding to not overlap.
          On md+: flex-row side by side layout as before.
        -->
        <div
          class="blog-card relative flex flex-col md:flex-row gap-6 items-stretch"
          data-title="{{ post.title | downcase }}"
          data-author="{{ post.author | downcase }}"
          data-tags="{{ post.tags | join:',' | downcase }}"
          data-type="{{ post.type }}"
        >
          <!-- Image -->
          <!-- On mobile: absolute positioning. On md and up: revert to static positioning -->
          <div class="image-container md:static absolute md:relative top-0 left-0 w-full md:w-48 h-48 md:h-auto flex-shrink-0 rounded-lg border overflow-hidden"
            :class="darkMode ? 'border-gray-800' : 'border-gray-200'">
            {% if post.image %}
            <div class="w-full h-full bg-cover bg-[position:0%_0%] transition-[background-position] duration-[1500ms] hover:bg-[position:100%_100%]"
                      style="background-image: url('{{ post.image | relative_url }}');"
                      alt="{{ post.title }}">
                </div>
            {% else %}
            <div class="absolute inset-0 flex items-center justify-center text-gray-400">
              <i data-lucide="image" class="w-6 h-6"></i>
            </div>
            {% endif %}
          </div>

          <!-- Text Container -->
          <!-- Add top padding on mobile to ensure text doesn't appear behind the image -->
          <div class="flex-1 min-w-0 flex flex-col justify-center pt-52 md:pt-0">
            <div class="flex items-start justify-between mb-3">
              <h3 class="text-xl font-bold transition-colors"
                :class="darkMode ? 'text-white' : 'text-gray-900'">
                {{ post.title }}
              </h3>
              <span class="px-3 py-1 rounded-full text-sm font-medium"
                :class="darkMode ? 'bg-blue-900/90 text-blue-200' : 'bg-blue-100 text-blue-800'">
                <i data-lucide="{{ ctype_icon }}" class="w-4 h-4 inline-block mr-1"></i>
                {{ ctype_label }}
              </span>
            </div>

            {% if post.tags %}
            <div class="flex flex-wrap gap-2 mb-3">
              {% for t in post.tags %}
              <span class="px-2 py-0.5 rounded-full text-xs font-medium flex items-center gap-1"
                :class="darkMode ? 'bg-gray-800 text-gray-300' : 'bg-gray-100 text-gray-800'">
                <i data-lucide="tag" class="w-3 h-3"></i>
                {{ t }}
              </span>
              {% endfor %}
            </div>
            {% endif %}

            {% if post.description %}
            <p class="mb-4 text-sm"
              :class="darkMode ? 'text-gray-400' : 'text-gray-600'">
              {{ post.description }}
            </p>
            {% endif %}

            <!-- Metadata -->
            <div class="flex flex-wrap items-center gap-4 text-sm">
              {% if post.author %}
              <div class="flex items-center gap-2 text-gray-500 dark:text-gray-400">
                <i data-lucide="user" class="w-4 h-4"></i>
                <span>{{ post.author }}</span>
              </div>
              {% endif %}

              {% if display_read_time %}
                {% if post.date %}
                <div class="flex items-center gap-2 text-gray-500 dark:text-gray-400">
                  <i data-lucide="calendar" class="w-4 h-4"></i>
                  <span>{{ post.date | date: "%b %d, %Y" }}</span>
                </div>
                {% endif %}
                <div class="flex items-center gap-2 text-gray-500 dark:text-gray-400">
                  <i data-lucide="clock" class="w-4 h-4"></i>
                  <span>{{ read_time }} min read</span>
                </div>
              {% endif %}

              {% if display_event_fields %}
                {% if post.location %}
                <div class="flex items-center gap-2 text-gray-500 dark:text-gray-400">
                  <i data-lucide="map-pin" class="w-4 h-4"></i>
                  <span>{{ post.location }}</span>
                </div>
                {% endif %}

                {% if post.duration %}
                <div class="flex items-center gap-2 text-gray-500 dark:text-gray-400">
                  <i data-lucide="clock" class="w-4 h-4"></i>
                  <span>{{ post.duration }}</span>
                </div>
                {% endif %}

                {% if post.date %}
                <div class="flex items-center gap-2 text-gray-500 dark:text-gray-400">
                  <i data-lucide="calendar" class="w-4 h-4"></i>
                  <span>{{ post.date | date: "%b %d, %Y" }}</span>
                </div>
                {% endif %}
              {% endif %}
            </div>
          </div>
        </div>
      </a>
      {% endfor %}
    </div>

    <div id="noBlogMessage" class="hidden mt-6 text-center">
      <p :class="darkMode ? 'text-gray-300' : 'text-gray-600'">No posts found.</p>
    </div>
  </div>
</section>
