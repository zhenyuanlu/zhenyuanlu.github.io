<!-- Share Menu Component -->
<div x-data="{ 
  isOpen: false,
  showQR: false,
  isMobile: window.innerWidth < 768,
  copied: false
}" class="relative inline-block text-left">
  <!-- Share Button -->
  <button
    @click="isOpen = !isOpen"
    class="inline-flex items-center gap-2 px-4 py-2 rounded-lg transition-colors"
    :class="darkMode ? 'bg-gray-800 text-gray-200 hover:bg-gray-700' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
  >
    <i data-lucide="share-2" class="w-4 h-4"></i>
    <span class="text-sm">Share</span>
  </button>

  <!-- Dropdown Menu -->
  <div
    x-show="isOpen"
    @click.outside="isOpen = false; showQR = false"
    x-transition:enter="transition ease-out duration-200"
    x-transition:enter-start="opacity-0 translate-y-2"
    x-transition:enter-end="opacity-100 translate-y-0"
    x-transition:leave="transition ease-in duration-150"
    x-transition:leave-start="opacity-100 translate-y-0"
    x-transition:leave-end="opacity-0 translate-y-2"
    class="absolute right-0 mt-2 w-56 rounded-xl overflow-hidden shadow-lg ring-1 z-50"
    :class="darkMode ? 'bg-gray-900 ring-white/10' : 'bg-white ring-black/5'"
    style="display: none;"
  >
    <!-- Header -->
    <div class="px-4 py-3 border-b"
         :class="darkMode ? 'border-gray-800' : 'border-gray-200'">
      <h3 class="text-sm font-medium"
          :class="darkMode ? 'text-gray-200' : 'text-gray-700'">
        Share via
      </h3>
    </div>

    <!-- Share Options -->
    <div class="p-2 space-y-1">
      <!-- Native Share (Mobile Only) -->
      <template x-if="navigator.share">
        <button
          @click="navigator.share({
            title: document.title,
            url: window.location.href
          }).catch(console.error); isOpen = false;"
          class="flex items-center w-full gap-3 px-3 py-2 rounded-lg text-sm transition-colors"
          :class="darkMode ? 'text-gray-300 hover:bg-gray-800' : 'text-gray-700 hover:bg-gray-100'"
        >
          <i data-lucide="share" class="w-4 h-4"></i>
          <span>Share via...</span>
        </button>
      </template>

      <!-- Social Share Options -->
      <a
        href="#"
        @click.prevent="window.open(`https://twitter.com/intent/tweet?url=${encodeURIComponent(window.location.href)}&text=${encodeURIComponent(document.title)}`, '_blank'); isOpen = false;"
        class="flex items-center w-full gap-3 px-3 py-2 rounded-lg text-sm transition-colors"
        :class="darkMode ? 'text-gray-300 hover:bg-gray-800' : 'text-gray-700 hover:bg-gray-100'"
      >
        <i data-lucide="twitter" class="w-4 h-4"></i>
        <span>Twitter</span>
        <i data-lucide="external-link" class="w-3 h-3 ml-auto opacity-50"></i>
      </a>

      <a
        href="#"
        @click.prevent="window.open(`https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(window.location.href)}`, '_blank'); isOpen = false;"
        class="flex items-center w-full gap-3 px-3 py-2 rounded-lg text-sm transition-colors"
        :class="darkMode ? 'text-gray-300 hover:bg-gray-800' : 'text-gray-700 hover:bg-gray-100'"
      >
        <i data-lucide="linkedin" class="w-4 h-4"></i>
        <span>LinkedIn</span>
        <i data-lucide="external-link" class="w-3 h-3 ml-auto opacity-50"></i>
      </a>

      <a
        href="#"
        @click.prevent="window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(window.location.href)}`, '_blank'); isOpen = false;"
        class="flex items-center w-full gap-3 px-3 py-2 rounded-lg text-sm transition-colors"
        :class="darkMode ? 'text-gray-300 hover:bg-gray-800' : 'text-gray-700 hover:bg-gray-100'"
      >
        <i data-lucide="facebook" class="w-4 h-4"></i>
        <span>Facebook</span>
        <i data-lucide="external-link" class="w-3 h-3 ml-auto opacity-50"></i>
      </a>

      <!-- WeChat Share -->
      <button
        @click="showQR = !showQR"
        class="flex items-center w-full gap-3 px-3 py-2 rounded-lg text-sm transition-colors"
        :class="darkMode ? 'text-gray-300 hover:bg-gray-800' : 'text-gray-700 hover:bg-gray-100'"
      >
        <i data-lucide="message-circle" class="w-4 h-4"></i>
        <span>WeChat</span>
        <i data-lucide="chevron-down" class="w-3 h-3 ml-auto transition-transform" :class="{'rotate-180': showQR}"></i>
      </button>

      <!-- WeChat QR Panel -->
      <div
        x-show="showQR"
        x-transition
        class="px-3 py-2 mt-1 space-y-3 rounded-lg"
        :class="darkMode ? 'bg-gray-800/50' : 'bg-gray-50'"
      >
        <div id="qrcode" class="bg-white p-3 rounded-lg mx-auto w-32 h-32"></div>
        <p class="text-xs text-center" :class="darkMode ? 'text-gray-400' : 'text-gray-500'">
          Scan with WeChat to share
        </p>
      </div>

      <!-- Divider -->
      <div class="my-2 border-t" :class="darkMode ? 'border-gray-800' : 'border-gray-200'"></div>

      <!-- Copy Link -->
      <button
        @click="
          navigator.clipboard.writeText(window.location.href);
          copied = true;
          setTimeout(() => copied = false, 2000);
        "
        class="flex items-center w-full gap-3 px-3 py-2 rounded-lg text-sm transition-colors"
        :class="darkMode ? 'text-gray-300 hover:bg-gray-800' : 'text-gray-700 hover:bg-gray-100'"
      >
        <template x-if="!copied">
          <i data-lucide="link-2" class="w-4 h-4"></i>
        </template>
        <template x-if="copied">
          <i data-lucide="check" class="w-4 h-4 text-green-500"></i>
        </template>
        <span x-text="copied ? 'Copied!' : 'Copy link'"></span>
      </button>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<script>
// Initialize QR code when WeChat panel is shown
document.addEventListener('alpine:init', () => {
  Alpine.effect(() => {
    const showQR = Alpine.$data(document.querySelector('[x-data]')).showQR;
    if (showQR) {
      const qrContainer = document.getElementById('qrcode');
      qrContainer.innerHTML = '';
      new QRCode(qrContainer, {
        text: window.location.href,
        width: 128,
        height: 128,
        colorDark: "#000000",
        colorLight: "#ffffff",
        correctLevel: QRCode.CorrectLevel.H
      });
    }
  });
});

// Handle escape key
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    const shareMenu = document.querySelector('[x-data]');
    if (shareMenu) {
      const data = Alpine.$data(shareMenu);
      data.isOpen = false;
      data.showQR = false;
    }
  }
});

// Update mobile state on resize
window.addEventListener('resize', () => {
  const shareMenu = document.querySelector('[x-data]');
  if (shareMenu) {
    const data = Alpine.$data(shareMenu);
    data.isMobile = window.innerWidth < 768;
  }
});
</script>